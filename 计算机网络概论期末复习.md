# 数据链路层

## 链路

一条无源的点到点的物理线路段，中间没有任何其他的交换结点。

## 三个基本问题

### 封装成帧

在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。首部和尾部的一个重要作用就是进行帧定界。

控制字符SOH放在一帧的最前面，表示帧的首部开始；控制字符EOT表示帧的结束。

### 透明传输

发送端的数据链路层在数据中出现控制字符SOH或EOT的前面插入一个转义字符ESC，接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。

### 差错可控

在传输过程中可能会产生比特差错，为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。

在数据链路层传送的帧中，广泛使用了循环冗余检验CRC的检错技术。

在数据后面添加上的冗余码称为帧检测序列FCS.

仅用循环冗余检测CRC差错检测技术只能做到无差错接受，能够实现无比特差错的传输，但不是可靠传输。

## PPP协议

点对点的链路。

全双工通信。

三个组成部分：

* 将IP数据报封装到串行链路的方法。
* 链路控制协议LCP
* 网络控制协议NCP

PPP是面向字节的，所有的PPP帧的长度都是整数字节。

透明传输问题：

* 同步传输链路<br />零比特填充
* 异步传输链路<br />字符填充

## 适用于局域网的数据链路层协议

### 逻辑链路控制LLC子层

不管采用何种协议的局域网，对LLC子层来说都是透明的。

### 媒体介入控制MAC子层

与接入到传输媒体有关的内容都放在MAC层，而LLC子层则与传输媒体无关。

MAC地址：48位

MAC帧包含三种帧：

* 单播帧
* 广播帧
* 多播帧

以太网规定帧间最小间隔为9.6微秒，相当于96比特时间，其目的是为了使刚刚收到数据帧的站的接受缓存来得及清理，做好接受下一帧的准备。 当一个帧发送之后，10 Mbps 以太网中的所有设备都必须等待至少 96 个比特时间（9.6微秒），然后才可以发送下一个帧。

## 以太网的两种重要措施

1. 采用较为灵活的无连接的工作方式<br />以太网提供的服务是不可靠的交付，即尽最大努力的交付。
2. 发送的数据使用曼彻斯特编码

## CSMA/CD协议

载波监听多点接入/碰撞检测

碰撞检测就是计算机边发送数据边检测信道上的信号电压大小。

将单程端到端的传播时延记为$\tau$, 则最先发送数据帧的站，在发送数据帧后至多经过时间$2\tau$就可知道发送的数据帧是否遭受了碰撞。以太网的端到端往返时延$2\tau$称为争用期。经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

记帧的发送时间为$T_0$, $\alpha=\frac{\tau}{T_0}$, $\alpha$越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。

发生碰撞的站在检测到碰撞后，采用二进制指数类型退避算法进行重传。

半双工通信。

## 以太网交换机

每个接口工作在全双工方式。不使用CSMA/CD协议。

帧交换表（地址表）通过自学习算法自动地逐渐建立起来的。

通过生成树协议STP解决了兜圈子的现象。

# 网络层

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。

## 中继系统

* 物理层中继系统：转发器
* 数据链路层中继系统：网桥或桥接器
* 网络层中继系统：路由器
* 网络层以上的中继系统：网关

## IP协议

IP地址：32位

一个路由器至少应当有两个不同的IP地址。

IP数据报首部检验和的计算采用16位二进制反码求和算法。（二进制反码加法：$f(a, b)=(a+b)\%16+(a+b)/16$

### IP地址的编址方式

#### 分类的IP地址

|         | 开头 | 网络地址 | 网络地址位数 |
| ------- | ---- | -------- | ------------ |
| A类地址 | 0    | 0~127    | 8            |
| B类地址 | 10   | 128~191  | 16           |
| C类地址 | 110  | 192~223  | 24           |
| D类地址 | 1110 | 224~239  |              |
| E类地址 | 1111 | 240~245  |              |

#### 划分子网

从主机号中借用若干位作为子网号

子网划分有固定长度子网和变长子网两种子网划分方法。

#### 构成超网

在变长子网掩码的基础上又进一步研究出无分类编址方法CIDR. 采用斜线记法，表示网络前缀所占的位数。

一个CIDR地址块可以表示很多地址，这种地址的聚合称为路由聚合，又称为构成超网。

## ARP协议

从网络层使用的IP协议，解析出在数据链路层使用的硬件地址。

包含ARP请求分组和ARP响应分组。

## ICMP协议

允许主机或路由器报告差错情况和提供有关的异常情况的报告。

包含ICMP差错报告报文和ICMP询问报文。

PING利用ICMP询问报文，traceroute利用ICMP差错报文。

## IGMP协议

让连接在本地局域网上的多播路由器知道本局域网上是否有主机参加或退出了某个多播组。

工作可分为两个阶段：

1. 加入多播组<br />当某个主机加入新的多播组时，向多播组的多播地址发送IGMP报文，声明自己要成为该组的成员。<br />本地的多播路由器收到IGMP报文后，将组成员关系转发给互联网上的其他多播路由器。
2. 探寻组成员变化情况<br />本地多播路由器周期性地探寻本地局域网上的主机，只要对某个组有一个主机响应，那么多播路由器就认为这个组是活跃的。<br />对所有的组发送一个请求信息的询问报文，而不需要对每一个组发送一个询问报文。

## 路由器

路由器结构可分为三大部分：

* 路由选择部分
* 分组转发部分
* 输入输出部分

### 路由选择

核心是路由选择处理机。

任务是根据所选定的路由协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。

### 分组转发部分

交换结构的作用是根据转发表对分组进行处理。拥有一组输入端口和一组输出端口。

实现交换有多种方法，常用的交换方法有三种：

* 存储器
* 总线
* 纵横交换结构

### 输入输出部分

输入端口中的查找和转发功能在路由器的交换功能中是最重要的。

在网络层的处理模块中设有一个缓冲区。当交换结构传送过来的分组的速率超过输出链路的发送速率时，来不及发送的分组就必须暂时存放在这个队列中。

### 路由表

#### 特定主机路由

虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。

#### 默认路由

#### 最长前缀匹配

使用CIDR时，在查找路由表时可能会得到不止一个匹配结果，应当从匹配结果中选择具有最长网络前缀的路由。

## 路由选择协议

互联网采用分层次的路由选择协议。

### 自治系统AS

在处于一个管理机构控制之下的、采用统一技术逻辑的路由器及网络群组，具有全局唯一的AS ID.

AS内部采用一直的路由选择协议和度量标准来形成路由表；AS之间采用独特的路由选择协议确定AS之间的路由。

### 内部网关协议IGP

在一个自治系统内部使用的路由选择协议。

#### 路由信息协议RIP

分布式的、基于距离向量的路由选择协议。

要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离纪录。

RIP只适用于小型互联网，不能在两个网络之间同时使用多条路由。

特点：

* 仅和相邻路由器交换信息
* 交换的信息是当前本路由器所知道的全部信息，即自己的路由表
* 按固定的时间间隔交换路由信息

路由表的更新：

* 如果新的距离小于已知值，则采用新的路由
* 如果发送者是已知路由信息的来源，则即使新的距离大于已知值，也采用新的路由

##### 优点

实现简单，开销较小

##### 缺点

* 限制了网络的规模
* 随着网络规模的扩大，开销也就增加
* 坏消息传播的慢，使更新过程的收敛时间过长
* 封装在UDP协议中

### 开放最短路径优先OSPF协议

向本自治系统中所有路由器发送信息。

发送的信息是与本路由器相邻的所有路由器的链路状态，但只是部分信息。

只有当链路状态发生变化时，才会向所有路由器发送此信息。

OSPF的更新过程收敛得快。

OSPF不用UDP而直接用IP数据报传送。

如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫多路径间的负载平衡。

所有在OSPF路由器之间交换的分组都具有鉴别的功能。

支持可变长度的子网划分和CIDR

### 外部网关协议EGP

将路由选择信息传递到另一个自治系统中的协议。

#### 边界网关协议BGP

力求寻找一条能够到达目的网路且比较好的路由（不能兜圈子），而并非寻找一条最佳路由。

封装在TCP报文中。

BGP所交换的网络可达性的信息就是要到达某个网络所有经过的一系列AS.

## IPv6

向IPv6过渡的策略：

* 双协议栈
* 隧道

## IP多播

多播数据报尽最大努力交付，不产生ICMP差错报文。

多播路由选择协议在转发多播数据报时使用三种方法：

* 洪泛与剪除<br />适用于较小的多播组。为了避免兜圈子，采用了反向路径传播RPB的策略。
* 隧道
* 基于核心的发现技术

# 运输层

## 端口

端口号：16位

| 协议  | 端口号 |
| ---- | ------ |
| DNS | 53     |
| TFTP | 69 |
| RPC | 111 |
| SNMP | 161 |
| SMTP | 25 |
| FTP | 20, 21 |
| Telnet | 23 |
| HTTP | 80 |
| HTTPS | 443 |



## UDP

* 复用和分用的功能
* 差错检错的功能

主要特点

* 无连接的
* 使用尽最大努力交付
* 面向报文的<br />一次交付一个完整的报文，若太长则由IP层分片
* 没有拥塞控制
* 支持一对一、一对多、多对一和多对多的交互通信
* 首部开销小

校验和的单位是2字节

## TCP

* 面向连接
* 点对点
* 可靠交付
* 全双工
* 面向字节流<br />不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系，但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样。

### 停止等待协议

每发送完一个分组就停止发送，等待对方的确认。在收到确认后再发送下一个分组。

缺点是信道利用率过低。

若接收时出现差错（检测出差错，或丢失），则接收方什么都不做，发送方超时重传。此时接收方收到了重传的分组后，丢弃这个重复的分组，不向上层交付，同时向发送方发送确认。

在发送完一个分组后，必须暂时保留已发送的分组的副本，以备重发。

超时计时器的重传时间应当比数据在分组传输的平均往返时间更长一些。

### 连续ARQ协议

发送方每收到一个确认，就把发送串口向前滑动一个分组的位置。

接收方一般采用累计确认的方式，对按序到达的最后一个分组发送确认。

MSS是TCP报文段中的数据字段的最大长度。

发送缓存用于存放：

* 发送应用程序传送给发送方TCP准备发送的数据
* TCP已发送出但尚未收到确认的数据

接收缓存用于存放：

* 按序到达的、但尚未被接受应用程序读取的数据
* 不按序到达的数据

### TCP超时重传时间的选择

采用自适应算法，记录一个报文发出的时间，以及收到响应的确认的时间，这两个时间之差就是报文段的往返时间RTT.

$$
RTT_S=(1-\alpha)RTT_S+\alpha RTT
$$

$$
RTT_D=(1-\beta)RTT_D+\beta|RTT_s-RTT|
$$

$$
RTO=RTT_S+4RTT_D
$$

### TCP拥塞控制算法

#### 慢开始

由小到大逐渐增加拥塞窗口数值

#### 拥塞避免

让拥塞窗口缓慢地增大，按线性规律缓慢增大

#### 快重传

失序到达的情况下，启动快重传。

发送方之遥一连收到三个重复确认，那么立即重传。

#### 快恢复